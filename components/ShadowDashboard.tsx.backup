// components/ShadowDashboard.tsx
import React, { useEffect, useState } from 'react';
import { virtualTradingService, VirtualAccount } from '../services/VirtualTradingService';
import { autoPilotService } from '../services/AutoPilotService';
import { supabase } from '../services/supabaseClient';
import { marketRegimeService, MarketRegimeStatus } from '../services/MarketRegimeService';
import { isMockDataEnabled } from '../services/dataService';
import { SniperTriggerAlert } from './SniperTriggerAlert';
import { PerformanceDashboard } from './PerformanceDashboard';
import { TelegramNotificationSettings } from './TelegramNotificationSettings';
import type { MarketTarget, TradingStrategy, StrategyConfig } from '../types';

interface ShadowDashboardProps {
    marketTarget?: MarketTarget;
}

export const ShadowDashboard: React.FC<ShadowDashboardProps> = ({ marketTarget = 'KR' }) => {
    const [account, setAccount] = useState<VirtualAccount | null>(null);
    const [isAutoPilotOn, setIsAutoPilotOn] = useState(false);
    const [regimeStatus, setRegimeStatus] = useState<MarketRegimeStatus | null>(null);
    const [selectedTicker, setSelectedTicker] = useState<string | null>(null);
    const [currentStrategy, setCurrentStrategy] = useState<TradingStrategy>('DAY');
    const [strategyConfig, setStrategyConfig] = useState<StrategyConfig>(autoPilotService.getStrategyConfig());
    const [recentLessons, setRecentLessons] = useState<{ date: string; lesson: string; score: number }[]>([]);
    const isMock = isMockDataEnabled();

    useEffect(() => {
        // Sync market target with services
        virtualTradingService.setMarketTarget(marketTarget);
        autoPilotService.setMarketTarget(marketTarget);

        // Ï¥àÍ∏∞ Î°úÎìú
        setAccount(virtualTradingService.getAccount());
        setIsAutoPilotOn(autoPilotService.getStatus().isRunning);
        setStrategyConfig(autoPilotService.getStrategyConfig());
        marketRegimeService.analyzeCurrentRegime(marketTarget).then(setRegimeStatus);

        // Ï£ºÍ∏∞Ï†Å Í∞±Ïã† (1Ï¥àÎßàÎã§ UI ÏóÖÎç∞Ïù¥Ìä∏)
        const interval = setInterval(() => {
            setAccount({ ...virtualTradingService.getAccount() }); // Force refresh
            setIsAutoPilotOn(autoPilotService.getStatus().isRunning);
            const status = marketRegimeService.getLastStatus(marketTarget);
            if (status) setRegimeStatus(status);
        }, 1000);

        // Fetch AI Lessons
        const fetchLessons = async () => {
            if (!supabase) return;
            const { data } = await supabase
                .from('ai_trade_journals')
                .select('created_at, lessons_learned, score')
                .order('created_at', { ascending: false })
                .limit(3);

            if (data) {
                setRecentLessons((data as any[]).map(d => ({
                    date: new Date(d.created_at).toLocaleDateString(),
                    lesson: d.lessons_learned,
                    score: d.score
                })));
            }
        };
        fetchLessons();

        return () => clearInterval(interval);
    }, [marketTarget]);

    const toggleAutoPilot = () => {
        if (isAutoPilotOn) {
            autoPilotService.stop();
            setIsAutoPilotOn(false);
        } else {
            autoPilotService.start();
            setIsAutoPilotOn(true);
        }
    };

    const resetAccount = () => {
        if (confirm('Ï†ïÎßê Í∞ÄÏÉÅ Í≥ÑÏ¢åÎ•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå? Î™®Îì† Í∏∞Î°ùÏù¥ ÏÇ≠Ï†úÎê©ÎãàÎã§.')) {
            virtualTradingService.resetAccount();
            setAccount(virtualTradingService.getAccount());
        }
    };

    const handleStrategyChange = (strategy: TradingStrategy) => {
        setCurrentStrategy(strategy);
        autoPilotService.setStrategy(strategy);
        setStrategyConfig(autoPilotService.getStrategyConfig());
    };

    if (!account) return <div>Loading Shadow Trader...</div>;

    const totalReturn = ((account.totalAsset - account.initialCapital) / account.initialCapital) * 100;
    const winCount = account.tradeLogs.filter(l => l.type === 'SELL' && l.amount > (l.price * l.quantity)).length;
    const totalTrades = account.tradeLogs.filter(l => l.type === 'SELL').length;
    const winRate = totalTrades > 0 ? (winCount / totalTrades) * 100 : 0;

    return (
        <>
            <SniperTriggerAlert />
            <div className="bg-gray-900 text-white p-6 rounded-xl shadow-2xl border border-gray-700">
                <header className="flex justify-between items-center mb-6">
                    <div>
                        <h2 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600 flex items-center gap-2">
                            üåë SHADOW TRADER
                            {isMock && <span className="text-xs bg-yellow-500 text-black px-2 py-0.5 rounded-full font-extrabold tracking-tighter">TEST MODE</span>}
                        </h2>
                        <p className="text-xs text-gray-400">Autonomous Virtual Trading Engine {isMock && '(Using Synthetic Data)'}</p>
                    </div>
                    <div className="flex gap-3">
                        <button
                            onClick={toggleAutoPilot}
                            className={`px-4 py-2 rounded-lg font-bold transition-all ${isAutoPilotOn
                                ? 'bg-green-600 hover:bg-green-500 animate-pulse'
                                : 'bg-gray-700 hover:bg-gray-600'
                                }`}
                        >
                            {isAutoPilotOn ? 'üü¢ AUTO-PILOT ON' : 'üî¥ AUTO-PILOT OFF'}
                        </button>
                        <button
                            onClick={async () => {
                                const success = await virtualTradingService.syncWithKisAccount();
                                if (success) {
                                    virtualTradingService.removeTestLogs();
                                    alert('Í≥ÑÏ¢å ÎèôÍ∏∞Ìôî Î∞è ÌÖåÏä§Ìä∏ Î°úÍ∑∏ Ï†ïÎ¶¨ ÏôÑÎ£å!');
                                    setAccount({ ...virtualTradingService.getAccount() }); // Update state instead of reload
                                } else {
                                    alert('Í≥ÑÏ¢å ÎèôÍ∏∞Ìôî Ïã§Ìå®. KIS Proxy Î°úÍ∑∏Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
                                }
                            }}
                            className="px-3 py-2 bg-green-900/50 hover:bg-green-800 rounded-lg text-xs text-green-200"
                        >
                            üîÑ Í≥ÑÏ¢å ÎèôÍ∏∞Ìôî
                        </button>
                        <button onClick={resetAccount} className="px-3 py-2 bg-red-900/50 hover:bg-red-800 rounded-lg text-xs text-red-200">
                            Reset
                        </button>
                    </div>
                </header>

                {/* Market Regime Card */}
                {regimeStatus && (
                    <div className="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-600 bg-gradient-to-r from-gray-800 to-gray-900">
                        <div className="flex justify-between items-center">
                            <div>
                                <h3 className="text-gray-400 text-xs uppercase tracking-wider font-semibold">Market Regime (ÏãúÏû• Íµ≠Î©¥)</h3>
                                <div className="text-2xl font-bold text-white flex items-center gap-3 mt-1">
                                    <span className={`${regimeStatus.score >= 60 ? 'text-red-400' : regimeStatus.score <= 40 ? 'text-blue-400' : 'text-yellow-400'}`}>
                                        {regimeStatus.regime.replace('_', ' ')}
                                    </span>
                                    <span className="text-xs px-2 py-1 rounded bg-gray-700 text-gray-300 font-mono">Score: {regimeStatus.score}</span>
                                </div>
                            </div>
                            <div className="text-right">
                                <div className="text-gray-400 text-xs font-semibold">Recommended Exposure (ÎπÑÏ§ë)</div>
                                <div className={`text-2xl font-mono font-bold ${regimeStatus.recommendedExposure > 0.5 ? 'text-green-400' : 'text-orange-400'}`}>
                                    {(regimeStatus.recommendedExposure * 100).toFixed(0)}%
                                </div>
                            </div>
                        </div>
                        <div className="mt-4 grid grid-cols-2 gap-3 text-xs">
                            <div className="bg-gray-700/30 p-2 rounded border border-gray-700">
                                <span className="text-gray-400 block mb-1">Macro (Í±∞ÏãúÍ≤ΩÏ†ú)</span>
                                <span className="font-bold text-white text-sm">{regimeStatus.factors.macro}</span>
                            </div>
                            <div className="bg-gray-700/30 p-2 rounded border border-gray-700">
                                <span className="text-gray-400 block mb-1">Technical (Í∏∞Ïà†Ï†Å)</span>
                                <span className="font-bold text-white text-sm">{regimeStatus.factors.technical}</span>
                            </div>
                        </div>
                    </div>
                )}

                {/* AI Evolution Log (Lessons Learned) */}
                {recentLessons.length > 0 && (
                    <div className="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-600">
                        <h3 className="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-3 flex items-center gap-2">
                            üß† AI Evolution Log (ÏµúÍ∑º ÌïôÏäµÎêú ÍµêÌõà)
                            <span className="animate-pulse w-2 h-2 rounded-full bg-green-500"></span>
                        </h3>
                        <div className="space-y-2">
                            {recentLessons.map((item, idx) => (
                                <div key={idx} className="bg-gray-700/50 p-3 rounded border-l-4 border-purple-500">
                                    <div className="flex justify-between items-start mb-1">
                                        <span className="text-xs text-gray-400">{item.date}</span>
                                        <span className="text-xs font-bold text-yellow-400">Score: {item.score}</span>
                                    </div>
                                    <p className="text-sm text-gray-200 italic">"{item.lesson}"</p>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {/* Trading Strategy Selector */}
                <div className="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-600">
                    <h3 className="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-3">Îß§Îß§ Ï†ÑÎûµ (Trading Strategy)</h3>
                    <div className="flex gap-2 mb-4">
                        {(['DAY', 'SWING', 'LONG'] as TradingStrategy[]).map((strategy) => (
                            <button
                                key={strategy}
                                onClick={() => handleStrategyChange(strategy)}
                                className={`flex-1 px-4 py-2 rounded-lg font-bold transition-all ${currentStrategy === strategy
                                    ? 'bg-cyan-600 text-white shadow-lg'
                                    : 'bg-gray-700 text-gray-400 hover:bg-gray-600'
                                    }`}
                            >
                                {strategy === 'DAY' ? 'Îã®ÌÉÄ' : strategy === 'SWING' ? 'Ïä§Ïúô' : 'Ïû•Í∏∞'}
                            </button>
                        ))}
                    </div>
                    <div className="grid grid-cols-2 gap-3 text-xs">
                        <div className="bg-gray-700/30 p-2 rounded border border-gray-700">
                            <span className="text-gray-400 block mb-1">ÏùµÏ†à Î™©Ìëú</span>
                            <span className="font-bold text-green-400 text-sm">+{strategyConfig.takeProfitPercent}%</span>
                        </div>
                        <div className="bg-gray-700/30 p-2 rounded border border-gray-700">
                            <span className="text-gray-400 block mb-1">ÏÜêÏ†à Í∏∞Ï§Ä</span>
                            <span className="font-bold text-red-400 text-sm">{strategyConfig.stopLossPercent}%</span>
                        </div>
                    </div>
                </div>

                {/* Account Summary */}
                <div className="grid grid-cols-3 gap-4 mb-6">
                    <div className="bg-gray-800 p-4 rounded-lg">
                        <div className="text-gray-400 text-xs">Î≥¥Ïú† ÌòÑÍ∏à</div>
                        <div className="text-xl font-mono">{virtualTradingService.formatCurrency(account.cash)}</div>
                    </div>
                    <div className="bg-gray-800 p-4 rounded-lg">
                        <div className="text-gray-400 text-xs">ÎàÑÏ†Å ÏàòÏùµÎ•†</div>
                        <div className={`text-xl font-mono font-bold ${totalReturn >= 0 ? 'text-red-400' : 'text-blue-400'}`}>
                            {totalReturn > 0 ? '+' : ''}{totalReturn.toFixed(2)}%
                        </div>
                    </div>
                    <div className="bg-gray-800 p-4 rounded-lg">
                        <div className="text-gray-400 text-xs">ÏäπÎ•† (Ï∂îÏ†ï)</div>
                        <div className="text-xl font-mono text-yellow-400">{winRate.toFixed(1)}%</div>
                    </div>
                </div>

                {/* Performance Dashboard */}
                <PerformanceDashboard marketTarget={marketTarget} />

                {/* Telegram Notification Settings */}
                <TelegramNotificationSettings />

                {/* Active Positions */}
                <div className="mb-6">
                    <h3 className="text-lg font-bold mb-3 text-gray-300">Î≥¥Ïú† Ìè¨ÏßÄÏÖò ({account.positions.length})</h3>
                    <div className="bg-gray-800 rounded-lg overflow-hidden">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-700 text-gray-400">
                                <tr>
                                    <th className="p-3">Ï¢ÖÎ™©</th>
                                    <th className="p-3">ÏàòÎüâ</th>
                                    <th className="p-3">ÌèâÎã®Í∞Ä</th>
                                    <th className="p-3">ÌòÑÏû¨Í∞Ä</th>
                                    <th className="p-3">ÏàòÏùµÎ•†</th>
                                </tr>
                            </thead>
                            <tbody>
                                {account.positions.length === 0 ? (
                                    <tr><td colSpan={5} className="p-4 text-center text-gray-500">Î≥¥Ïú† Ï§ëÏù∏ Ï¢ÖÎ™©Ïù¥ ÏóÜÏäµÎãàÎã§.</td></tr>
                                ) : (
                                    account.positions.map(p => (
                                        <tr key={p.ticker} className="border-b border-gray-700 hover:bg-gray-700/50">
                                            <td className="p-3 font-bold">{p.stockName} <span className="text-xs text-gray-500">{p.ticker}</span></td>
                                            <td className="p-3">{p.quantity}Ï£º</td>
                                            <td className="p-3">{Math.floor(p.avgPrice).toLocaleString()}</td>
                                            <td className="p-3">{p.currentPrice.toLocaleString()}</td>
                                            <td className={`p-3 font-bold ${p.profitRate >= 0 ? 'text-red-400' : 'text-blue-400'}`}>
                                                {p.profitRate > 0 ? '+' : ''}{p.profitRate.toFixed(2)}%
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>

                {/* Trade Logs */}
                <div>
                    <h3 className="text-lg font-bold mb-3 text-gray-300">Îß§Îß§ Í∏∞Î°ù (ÏµúÍ∑º 10Í±¥)</h3>
                    <div className="bg-gray-800 rounded-lg overflow-hidden">
                        <table className="w-full text-xs text-left">
                            <thead className="bg-gray-700 text-gray-400">
                                <tr>
                                    <th className="p-2">ÏãúÍ∞Ñ</th>
    const winRate = totalTrades > 0 ? (winCount / totalTrades) * 100 : 0;

                                    return (
                                    <>
                                        <SniperTriggerAlert />
                                        <div className="bg-gray-900 text-white p-6 rounded-xl shadow-2xl border border-gray-700">
                                            <header className="flex justify-between items-center mb-6">
                                                <div>
                                                    <h2 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600 flex items-center gap-2">
                                                        üåë SHADOW TRADER
                                                        {isMock && <span className="text-xs bg-yellow-500 text-black px-2 py-0.5 rounded-full font-extrabold tracking-tighter">TEST MODE</span>}
                                                    </h2>
                                                    <p className="text-xs text-gray-400">Autonomous Virtual Trading Engine {isMock && '(Using Synthetic Data)'}</p>
                                                </div>
                                                <div className="flex gap-3">
                                                    <button
                                                        onClick={toggleAutoPilot}
                                                        className={`px-4 py-2 rounded-lg font-bold transition-all ${isAutoPilotOn
                                                            ? 'bg-green-600 hover:bg-green-500 animate-pulse'
                                                            : 'bg-gray-700 hover:bg-gray-600'
                                                            }`}
                                                    >
                                                        {isAutoPilotOn ? 'üü¢ AUTO-PILOT ON' : 'üî¥ AUTO-PILOT OFF'}
                                                    </button>
                                                    <button
                                                        onClick={async () => {
                                                            const success = await virtualTradingService.syncWithKisAccount();
                                                            if (success) {
                                                                virtualTradingService.removeTestLogs();
                                                                alert('Í≥ÑÏ¢å ÎèôÍ∏∞Ìôî Î∞è ÌÖåÏä§Ìä∏ Î°úÍ∑∏ Ï†ïÎ¶¨ ÏôÑÎ£å!');
                                                                setAccount({ ...virtualTradingService.getAccount() }); // Update state instead of reload
                                                            } else {
                                                                alert('Í≥ÑÏ¢å ÎèôÍ∏∞Ìôî Ïã§Ìå®. KIS Proxy Î°úÍ∑∏Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
                                                            }
                                                        }}
                                                        className="px-3 py-2 bg-green-900/50 hover:bg-green-800 rounded-lg text-xs text-green-200"
                                                    >
                                                        üîÑ Í≥ÑÏ¢å ÎèôÍ∏∞Ìôî
                                                    </button>
                                                    <button onClick={resetAccount} className="px-3 py-2 bg-red-900/50 hover:bg-red-800 rounded-lg text-xs text-red-200">
                                                        Reset
                                                    </button>
                                                </div>
                                            </header>

                                            {/* Market Regime Card */}
                                            {regimeStatus && (
                                                <div className="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-600 bg-gradient-to-r from-gray-800 to-gray-900">
                                                    <div className="flex justify-between items-center">
                                                        <div>
                                                            <h3 className="text-gray-400 text-xs uppercase tracking-wider font-semibold">Market Regime (ÏãúÏû• Íµ≠Î©¥)</h3>
                                                            <div className="text-2xl font-bold text-white flex items-center gap-3 mt-1">
                                                                <span className={`${regimeStatus.score >= 60 ? 'text-red-400' : regimeStatus.score <= 40 ? 'text-blue-400' : 'text-yellow-400'}`}>
                                                                    {regimeStatus.regime.replace('_', ' ')}
                                                                </span>
                                                                <span className="text-xs px-2 py-1 rounded bg-gray-700 text-gray-300 font-mono">Score: {regimeStatus.score}</span>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-gray-400 text-xs font-semibold">Recommended Exposure (ÎπÑÏ§ë)</div>
                                                            <div className={`text-2xl font-mono font-bold ${regimeStatus.recommendedExposure > 0.5 ? 'text-green-400' : 'text-orange-400'}`}>
                                                                {(regimeStatus.recommendedExposure * 100).toFixed(0)}%
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="mt-4 grid grid-cols-2 gap-3 text-xs">
                                                        <div className="bg-gray-700/30 p-2 rounded border border-gray-700">
                                                            <span className="text-gray-400 block mb-1">Macro (Í±∞ÏãúÍ≤ΩÏ†ú)</span>
                                                            <span className="font-bold text-white text-sm">{regimeStatus.factors.macro}</span>
                                                        </div>
                                                        <div className="bg-gray-700/30 p-2 rounded border border-gray-700">
                                                            <span className="text-gray-400 block mb-1">Technical (Í∏∞Ïà†Ï†Å)</span>
                                                            <span className="font-bold text-white text-sm">{regimeStatus.factors.technical}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {/* AI Evolution Log (Lessons Learned) */}
                                            {recentLessons.length > 0 && (
                                                <div className="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-600">
                                                    <h3 className="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-3 flex items-center gap-2">
                                                        üß† AI Evolution Log (ÏµúÍ∑º ÌïôÏäµÎêú ÍµêÌõà)
                                                        <span className="animate-pulse w-2 h-2 rounded-full bg-green-500"></span>
                                                    </h3>
                                                    <div className="space-y-2">
                                                        {recentLessons.map((item, idx) => (
                                                            <div key={idx} className="bg-gray-700/50 p-3 rounded border-l-4 border-purple-500">
                                                                <div className="flex justify-between items-start mb-1">
                                                                    <span className="text-xs text-gray-400">{item.date}</span>
                                                                    <span className="text-xs font-bold text-yellow-400">Score: {item.score}</span>
                                                                </div>
                                                                <p className="text-sm text-gray-200 italic">"{item.lesson}"</p>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            {/* Trading Strategy Selector */}
                                            <div className="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-600">
                                                <h3 className="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-3">Îß§Îß§ Ï†ÑÎûµ (Trading Strategy)</h3>
                                                <div className="flex gap-2 mb-4">
                                                    {(['DAY', 'SWING', 'LONG'] as TradingStrategy[]).map((strategy) => (
                                                        <button
                                                            key={strategy}
                                                            onClick={() => handleStrategyChange(strategy)}
                                                            className={`flex-1 px-4 py-2 rounded-lg font-bold transition-all ${currentStrategy === strategy
                                                                ? 'bg-cyan-600 text-white shadow-lg'
                                                                : 'bg-gray-700 text-gray-400 hover:bg-gray-600'
                                                                }`}
                                                        >
                                                            {strategy === 'DAY' ? 'Îã®ÌÉÄ' : strategy === 'SWING' ? 'Ïä§Ïúô' : 'Ïû•Í∏∞'}
                                                        </button>
                                                    ))}
                                                </div>
                                                <div className="grid grid-cols-2 gap-3 text-xs">
                                                    <div className="bg-gray-700/30 p-2 rounded border border-gray-700">
                                                        <span className="text-gray-400 block mb-1">ÏùµÏ†à Î™©Ìëú</span>
                                                        <span className="font-bold text-green-400 text-sm">+{strategyConfig.takeProfitPercent}%</span>
                                                    </div>
                                                    <div className="bg-gray-700/30 p-2 rounded border border-gray-700">
                                                        <span className="text-gray-400 block mb-1">ÏÜêÏ†à Í∏∞Ï§Ä</span>
                                                        <span className="font-bold text-red-400 text-sm">{strategyConfig.stopLossPercent}%</span>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Account Summary */}
                                            <div className="grid grid-cols-3 gap-4 mb-6">
                                                <div className="bg-gray-800 p-4 rounded-lg">
                                                    <div className="text-gray-400 text-xs">Î≥¥Ïú† ÌòÑÍ∏à</div>
                                                    <div className="text-xl font-mono">{virtualTradingService.formatCurrency(account.cash)}</div>
                                                </div>
                                                <div className="bg-gray-800 p-4 rounded-lg">
                                                    <div className="text-gray-400 text-xs">ÎàÑÏ†Å ÏàòÏùµÎ•†</div>
                                                    <div className={`text-xl font-mono font-bold ${totalReturn >= 0 ? 'text-red-400' : 'text-blue-400'}`}>
                                                        {totalReturn > 0 ? '+' : ''}{totalReturn.toFixed(2)}%
                                                    </div>
                                                </div>
                                                <div className="bg-gray-800 p-4 rounded-lg">
                                                    <div className="text-gray-400 text-xs">ÏäπÎ•† (Ï∂îÏ†ï)</div>
                                                    <div className="text-xl font-mono text-yellow-400">{winRate.toFixed(1)}%</div>
                                                </div>
                                            </div>

                                            {/* Performance Dashboard */}
                                            <PerformanceDashboard marketTarget={marketTarget} />

                                            {/* Telegram Notification Settings */}
                                            <TelegramNotificationSettings />

                                            {/* Active Positions */}
                                            <div className="mb-6">
                                                <h3 className="text-lg font-bold mb-3 text-gray-300">Î≥¥Ïú† Ìè¨ÏßÄÏÖò ({account.positions.length})</h3>
                                                <div className="bg-gray-800 rounded-lg overflow-hidden">
                                                    <table className="w-full text-sm text-left">
                                                        <thead className="bg-gray-700 text-gray-400">
                                                            <tr>
                                                                <th className="p-3">Ï¢ÖÎ™©</th>
                                                                <th className="p-3">ÏàòÎüâ</th>
                                                                <th className="p-3">ÌèâÎã®Í∞Ä</th>
                                                                <th className="p-3">ÌòÑÏû¨Í∞Ä</th>
                                                                <th className="p-3">ÏàòÏùµÎ•†</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {account.positions.length === 0 ? (
                                                                <tr><td colSpan={5} className="p-4 text-center text-gray-500">Î≥¥Ïú† Ï§ëÏù∏ Ï¢ÖÎ™©Ïù¥ ÏóÜÏäµÎãàÎã§.</td></tr>
                                                            ) : (
                                                                account.positions.map(p => (
                                                                    <tr key={p.ticker} className="border-b border-gray-700 hover:bg-gray-700/50">
                                                                        <td className="p-3 font-bold">{p.stockName} <span className="text-xs text-gray-500">{p.ticker}</span></td>
                                                                        <td className="p-3">{p.quantity}Ï£º</td>
                                                                        <td className="p-3">{Math.floor(p.avgPrice).toLocaleString()}</td>
                                                                        <td className="p-3">{p.currentPrice.toLocaleString()}</td>
                                                                        <td className={`p-3 font-bold ${p.profitRate >= 0 ? 'text-red-400' : 'text-blue-400'}`}>
                                                                            {p.profitRate > 0 ? '+' : ''}{p.profitRate.toFixed(2)}%
                                                                        </td>
                                                                    </tr>
                                                                ))
                                                            )}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>

                                            {/* Trade Logs */}
                                            <div>
                                                <h3 className="text-lg font-bold mb-3 text-gray-300">Îß§Îß§ Í∏∞Î°ù (ÏµúÍ∑º 10Í±¥)</h3>
                                                <div className="bg-gray-800 rounded-lg overflow-hidden">
                                                    <table className="w-full text-xs text-left">
                                                        <thead className="bg-gray-700 text-gray-400">
                                                            <tr>
                                                                <th className="p-2">ÏãúÍ∞Ñ</th>
                                                                <th className="p-2">Íµ¨Î∂Ñ</th>
                                                                <th className="p-2">Ï¢ÖÎ™©</th>
                                                                <th className="p-2">Í∞ÄÍ≤©</th>
                                                                <th className="p-2">ÏàòÎüâ</th>
                                                                <th className="p-2">Í∏àÏï°</th>
                                                                <th className="p-2">Í∑ºÍ±∞</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {account.tradeLogs.slice(0, 10).map((log, idx) => (
                                                                <tr key={idx} className="border-b border-gray-700">
                                                                    <td className="p-2 text-gray-500">{new Date(log.timestamp).toLocaleTimeString()}</td>
                                                                    <td className="p-2">
                                                                        <span className={`px-2 py-0.5 rounded text-xs font-bold ${log.type === 'BUY' ? 'bg-red-900 text-red-200' : 'bg-blue-900 text-blue-200'}`}>
                                                                            {log.type}
                                                                        </span>
                                                                    </td>
                                                                    <td className="p-2">{log.stockName}</td>
                                                                    <td className="p-2">{log.price.toLocaleString()}</td>
                                                                    <td className="p-2">{log.quantity}</td>
                                                                    <td className="p-2">{log.amount.toLocaleString()}</td>
                                                                    <td className="p-2 text-gray-400 text-xs max-w-xs truncate" title={log.reason || 'Í∑ºÍ±∞ ÏóÜÏùå'}>
                                                                        {log.reason || '-'}
                                                                    </td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </>
                                    );
};
